<!DOCTYPE html>

<html class="no-js">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Worm Game</title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-app.js"></script>
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
     https://firebase.google.com/docs/web/setup#available-libraries -->
    <!-- <script src="https://www.gstatic.com/firebasejs/7.13.2/firebase-analytics.js"></script> -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh"
      crossorigin="anonymous"
    />

    <link
      href="https://fonts.googleapis.com/css2?family=Patrick+Hand&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/p5@1.0.0/lib/p5.js"></script>
    <!-- <script src="./logic.js"></script> -->
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="col-md-4"></div>
        <div class="col-md-4">
          <div class="score">
            <p
              style="
                font-family: 'Patrick Hand';
                font-size: 30px;
                text-align: center;
              "
            >
              Worms Game
            </p>
            <p
              style="
                font-family: 'Patrick Hand';
                font-size: 30px;
                text-align: center;
              "
            >
              Score:
              <span
                id="score"
                style="
                  font-family: 'Patrick Hand';
                  font-size: 30px;
                  text-align: center;
                "
              ></span>
            </p>
          </div>
          <div>
            <p style="font-family: 'Patrick Hand'; text-align: center;">
              (Use the arrow keys on you're keyboard to guide the worm to it's
              food. Try to get a high score!)
            </p>
          </div>
        </div>
        <div class="col-md-4"></div>
      </div>
      <div class="row">
        <div class="col-md-2"></div>
        <div class="col-md-4">
          <div id="sketch-holder">
            <!-- Our sketch will go here! -->
          </div>
        </div>
        <div class="col-md-1"></div>
        <div class="col-md-3">
          <div id="">
            <p style="font-family: 'Patrick Hand'; font-size: 25px;">
              Leaderboard
            </p>
            <div
              id="leaderboard"
              style="font-family: 'Patrick Hand'; font-size: 20px;"
            ></div>
          </div>
        </div>
        <div class="col-md-2"></div>
      </div>
    </div>
    <!-- <div class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">You Died!</h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p>Please Enter Your Name:</p>
            <input />
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button type="button" class="btn btn-primary">Submit</button>
          </div>
        </div>
      </div>
    </div> -->
    <script>
      var s;
      var scl = 20;
      var food;
      var score = 0;
      var player = {};

      $(document).ready(() => {
        console.log("we're on the page");
        $.get("/api/get-scores", function (data) {
          data.sort((a, b) => (b.score > a.score ? 1 : -1));
          console.log("descending", data);
          let sortedArr = [];
          let listItem = "";
          for (let i = 0; i <= 9; i++) {
            sortedArr.push(data[i]);
          }
          jQuery.each(sortedArr, function (i, item) {
            $("#leaderboard").append(
              item.name + "  |  " + item.score + "<br/>"
            );
          });
        });
      });

      function setup() {
        canvas = createCanvas(400, 400);
        canvas.parent("sketch-holder");
        s = new Worm();
        frameRate(10);
        pickLocation();
      }

      function pickLocation() {
        var cols = floor(width / scl);
        var rows = floor(height / scl);
        food = createVector(floor(random(cols)), floor(random(rows)));
        food.mult(scl);
      }

      function draw() {
        background(51);
        s.death();
        s.update();
        s.show();

        if (s.eat(food)) {
          pickLocation();
        }

        fill(255, 0, 100);
        rect(food.x, food.y, scl, scl);
      }

      function keyPressed() {
        if (keyCode === UP_ARROW) {
          s.direction(0, -1);
        } else if (keyCode === DOWN_ARROW) {
          s.direction(0, 1);
        } else if (keyCode === RIGHT_ARROW) {
          s.direction(1, 0);
        } else if (keyCode === LEFT_ARROW) {
          s.direction(-1, 0);
        }
      }

      function Worm() {
        this.x = 0;
        this.y = 0;
        this.xspeed = 1;
        this.yspeed = 0;
        this.total = 0;
        this.tail = [];

        this.direction = function (x, y) {
          this.xspeed = x;
          this.yspeed = y;
        };

        this.eat = function (position) {
          var d = dist(this.x, this.y, position.x, position.y);

          if (d < 1) {
            this.total++;
            score++;
            document.getElementById("score").innerHTML = score;
            return true;
          } else {
            return false;
          }
        };

        this.death = function () {
          for (var i = 0; i < this.tail.length; i++) {
            var position = this.tail[i];
            var distance = dist(this.x, this.y, position.x, position.y);
            if (distance < 1) {
              this.total = 0;
              this.tail = [];

              player = { name: "Patty", score: score };
              $.post("/api/input-score", player, function () {
                console.log(player);
              });
              // $("modal").modal("show");

              alert("You Got Got Pal. Your score was " + score);
              location.reload();
            }
          }
        };

        this.update = function () {
          if (this.total === this.tail.length) {
            for (var i = 0; i < this.tail.length - 1; i++) {
              this.tail[i] = this.tail[i + 1];
            }
          }
          this.tail[this.total - 1] = createVector(this.x, this.y);

          this.x = this.x + this.xspeed * scl;
          this.y = this.y + this.yspeed * scl;

          this.x = constrain(this.x, 0, width - scl);
          this.y = constrain(this.y, 0, height - scl);
        };

        this.show = function () {
          fill(255);
          for (var i = 0; i < this.total; i++) {
            rect(this.tail[i].x, this.tail[i].y, scl, scl);
          }
          rect(this.x, this.y, scl, scl);
        };
      }
    </script>
  </body>
</html>
